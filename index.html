<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake</title>

<style>
body {
    font-family: Arial, sans-serif;
    text-align:center;
    background:#222;
    color:white;
    margin:0;
    overflow:hidden;
}
canvas {
    display:block;
    margin:10px auto;
    background:#111;
    border-radius:12px;
    box-shadow:0 0 25px rgba(0,255,0,0.25);
}
button {
    margin:5px; padding:10px 15px;
    border:none; border-radius:6px;
    background:#4CAF50; color:white;
    cursor:pointer;
}
button:hover { background:#45a049; }

#musicBtn {
    background:#0099ff;
}
#musicBtn:hover {
    background:#0080d1;
}

.controls {
    margin-top:10px;
}
.control-btn {
    width:65px; height:65px;
    margin:5px;
    font-size:30px;
    background:#333;
    border-radius:12px;
    display:inline-flex;
    justify-content:center;
    align-items:center;
    user-select:none;
    cursor:pointer;
    box-shadow:0 0 10px rgba(0,0,0,0.4);
}
.control-btn:active { background:#555; }
</style>
</head>
<body>

<h1>Snake</h1>

<canvas id="game"></canvas>

<div>
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pausa</button>
    <button id="replayBtn">Replay</button>
    <button id="musicBtn">Musica ON/OFF</button>
</div>

<p>Punteggio: <span id="score">0</span> | Record: <span id="best">0</span></p>

<!-- CONTROLLI -->
<div class="controls">
    <div class="control-btn" id="up">⬆</div><br>
    <div class="control-btn" id="left">⬅</div>
    <div class="control-btn" id="down">⬇</div>
    <div class="control-btn" id="right">➡</div>
</div>

<script>
// ========== CANVAS AUTO-SCALE ==========
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
    let size = Math.min(window.innerWidth * 0.9, window.innerHeight * 0.65);
    size = Math.max(300, size);
    canvas.width = size;
    canvas.height = size;
    CELL = size / GRID;
}
window.onresize = resizeCanvas;

// ========== CONFIG ==========
let GRID = 20;
let CELL;

resizeCanvas();

let snake, dir, nextDir, food, bonus;
let running = false;
let tickInterval = 150;
let score = 0;
let best = 0;
let speedBoost = false;
let comboTimer = 0;
let comboCount = 0;

// Particelle
let particles = [];

// Musica
const music = new Audio("https://www.bensound.com/bensound-music/bensound-creativeminds.mp3");
music.loop = true;
let musicOn = false;

// Suoni
const eatSound = new Audio("https://www.soundjay.com/button/sounds/button-16.mp3");
const bonusSound = new Audio("https://www.soundjay.com/button/sounds/button-09.mp3");
const startSound = new Audio("https://www.soundjay.com/button/sounds/button-3.mp3");

// ========== UTIL ==========
function rnd(min, max){ return Math.floor(Math.random()*(max-min))+min; }
function rndCell(){ return {x:rnd(0,GRID), y:rnd(0,GRID)}; }

// ========== GENERAZIONE ==========
function spawnFood(){
    let p;
    do p = rndCell();
    while (snake.some(s => s.x == p.x && s.y == p.y));
    food = p;
}

function resetGame(){
    snake = [{x:10, y:10}];
    dir = {x:0, y:0};
    nextDir = {x:1, y:0};
    score = 0;
    bonus = null;
    speedBoost = false;
    comboTimer = 0;
    comboCount = 0;
    particles = [];
    tickInterval = 150;

    spawnFood();

    best = Number(localStorage.getItem("snake_best")) || 0;
    document.getElementById("best").textContent = best;
    document.getElementById("score").textContent = score;

    draw();
}

// ========== PARTICELLE ==========
function spawnParticles(px, py, color) {
    for (let i=0;i<15;i++){
        particles.push({
            x:px, y:py,
            vx:(Math.random()-0.5)*4,
            vy:(Math.random()-0.5)*4,
            life:20,
            color:color
        });
    }
}

function updateParticles(){
    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life/20;
        ctx.fillRect(p.x, p.y, 4, 4);
        ctx.globalAlpha = 1;
    });
}

// ========== GAME LOOP ==========
let ticking = false;

function startTick(){
    if (ticking) return;
    ticking = true;
    startSound.play();
    tick();
}

function opposite(a,b){
    return (a.x === -b.x && a.y === -b.y);
}

function tick(){
    if (!running){
        ticking = false;
        return;
    }

    // BLOCCO INVERSIONI
    if (!opposite(dir, nextDir)) {
        dir = nextDir;
    }

    let head = {x:snake[0].x + dir.x, y:snake[0].y + dir.y};

    // collisione
    if (
        head.x < 0 || head.x >= GRID ||
        head.y < 0 || head.y >= GRID ||
        snake.some(s => s.x == head.x && s.y == head.y)
    ) {
        running = false;
        alert("Game Over! Punteggio: " + score);
        ticking = false;
        return;
    }

    snake.unshift(head);

    // MANGIA CIBO
    if (head.x == food.x && head.y == food.y){
        score++;
        comboCount++;
        comboTimer = 30; // 30 tick = ~5 secondi
        eatSound.play();

        // Effetti
        spawnParticles(head.x * CELL + CELL/2, head.y * CELL + CELL/2, "red");

        // COMBO
        if (comboCount >= 2){
            score += 5;
            comboCount = 0;
        }

        spawnFood();

        if (score % 5 == 0)
            tickInterval = Math.max(70, tickInterval - 10);

    } else {
        snake.pop();
    }

    // COMBO TIMER
    if (comboTimer > 0) comboTimer--;
    else comboCount = 0;

    // BEST
    if (score > best){
        best = score;
        localStorage.setItem("snake_best", best);
        document.getElementById("best").textContent = best;
    }
    document.getElementById("score").textContent = score;

    draw();

    setTimeout(tick, speedBoost ? tickInterval * 0.55 : tickInterval);
}

// ========== DISEGNO ==========
function draw(){
    ctx.fillStyle = "#111";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // cibo pulsante
    ctx.save();
    ctx.translate(food.x*CELL + CELL/2, food.y*CELL + CELL/2);
    let pulse = 1 + Math.sin(Date.now()/200)*0.15;
    ctx.scale(pulse, pulse);
    ctx.beginPath();
    ctx.fillStyle = "red";
    ctx.arc(0,0,CELL/2 - 3,0,Math.PI*2);
    ctx.fill();
    ctx.restore();

    // Serpente glow
    snake.forEach((s,i)=>{
        let x = s.x * CELL;
        let y = s.y * CELL;

        ctx.shadowColor = "#00ff66";
        ctx.shadowBlur = i==0 ? 20 : 10;

        ctx.fillStyle = i==0 ? "#00ff99" : "#00ff55";
        ctx.fillRect(x+2,y+2,CELL-4,CELL-4);
    });

    ctx.shadowBlur = 0;

    updateParticles();
}

// ========== INPUT ==========
document.addEventListener("keydown", e => {
    const k = e.key.toLowerCase();

    if (k==="arrowup"||k==="w") nextDir={x:0,y:-1};
    if (k==="arrowdown"||k==="s") nextDir={x:0,y:1};
    if (k==="arrowleft"||k==="a") nextDir={x:-1,y:0};
    if (k==="arrowright"||k==="d") nextDir={x:1,y:0};
});

// Touch buttons
["up","down","left","right"].forEach(id=>{
    document.getElementById(id).onclick=()=>{
        if(id==="up") nextDir={x:0,y:-1};
        if(id==="down") nextDir={x:0,y:1};
        if(id==="left") nextDir={x:-1,y:0};
        if(id==="right") nextDir={x:1,y:0};
    };
});

// Swipe mobile
let startX=0,startY=0;
canvas.addEventListener("touchstart",e=>{
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
});
canvas.addEventListener("touchend",e=>{
    let dx = e.changedTouches[0].clientX - startX;
    let dy = e.changedTouches[0].clientY - startY;

    if(Math.abs(dx)>Math.abs(dy)){
        if(dx>20) nextDir={x:1,y:0};
        else if(dx<-20) nextDir={x:-1,y:0};
    } else {
        if(dy>20) nextDir={x:0,y:1};
        else if(dy<-20) nextDir={x:0,y:-1};
    }
});

// ========== PULSANTI ==========
document.getElementById("playBtn").onclick = ()=>{
    running = true;
    startTick();
};
document.getElementById("pauseBtn").onclick = ()=>{
    running = false;
};
document.getElementById("replayBtn").onclick = ()=>{
    resetGame();
};
document.getElementById("musicBtn").onclick = ()=>{
    if (!musicOn){ music.play(); musicOn=true; }
    else { music.pause(); musicOn=false; }
};

resetGame();
</script>
</body>
</html>
